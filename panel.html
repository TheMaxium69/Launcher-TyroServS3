<!DOCTYPE html>
<html>
<!--Create By Maxime Tournier-->
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="module/iziToast.min.css">
    <script src="module/iziToast.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.min.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/all.css">

    <link rel="stylesheet" href="module/index.css">
    <link rel="stylesheet" href="module/navbar.css">
    <link rel="stylesheet" href="module/panel.css">

</head>

<body id="panel">


<!--NAVBAR -->
<nav style="-webkit-app-region: drag">
    <img src="asset/logo.png" width="20px" style="margin-left: 10px">
    <p id="title">TyroServ Launcher</p>
    <div class="nav-buttons">
        <button id="minimize"><i class="fa-light fa-window-minimize"></i></button>
<!--        <button id="maximize"><i class="fa-light fa-square"></i></button>-->
        <button id="close"><i class="fa-light fa-xmark"></i></button>
    </div>
</nav>



<main id="panel-faction">
<!--  UP LEFT  -->
    <section id="up-left">

        <div id="PP" onclick="launchSite('https://tyroserv.fr/player/')"></div>

        <div id="useritium-pseudo"></div>

        <h2 id="pseudo"></h2>

        <div id="stats-perso">

            <div id="grade-user" class="perso-tag">
                <p id="grade-user-text" class="perso-tag-text"></p>
            </div>

            <div id="level-user" class="perso-tag">
                <p id="level-user-text" class="perso-tag-text"></p>
            </div>

            <div id="money-user" class="perso-tag">
                <p id="money-user-text" class="perso-tag-text"></p>
            </div>

            <div id="faction-user" class="perso-tag">
                <p id="faction-user-text" class="perso-tag-text"></p>
            </div>


        </div>

    </section>

<!--  UP RIGHT  -->
    <section id="up-right">

        <div id="name-serv" onclick="launchSite('https://tyroserv.fr')">TYROSERV</div>
        <div id="type-serv" >PVP/FACTION</div>

        <img id="img-serv" src="asset/logo3d.png">

    </section>


<!--  ICONE LEFT  -->

    <section id="icone-left">

        <img id="useritium-account" onclick="launchSite('https://useritium.fr/connect.php')" src="https://tyrolium.fr/generate-pp/">

        <div id="setting" class="btnleft" onclick="launchOnglet('settings')">
<!--            <i class="ri-settings-fill icone-left"></i>-->
            <i class="ri-settings-3-fill icone-left"></i>
        </div>

        <div id="separebar"></div>

        <div id="link" class="btnleft" onclick="launchSite('https://tyroserv.fr')">
<!--            <i class="ri-global-line icone-left"></i>-->
            <i class="ri-links-line icone-left"></i>
        </div>
        <div id="discord" class="btnleft" onclick="launchSite('https://discord.gg/km8h5jHezt')">
            <i class="ri-discord-fill icone-left"></i>
        </div>
        <div id="instagram" class="btnleft" onclick="launchSite('https://www.instagram.com/tyroliumserver/')">
            <i class="ri-instagram-line icone-left"></i>
        </div>
        <div id="twitter" class="btnleft" onclick="launchSite('https://twitter.com/tyrolium')">
            <i class="ri-twitter-x-line icone-left"></i>
        </div>
        <div id="youtube" class="btnleft" onclick="launchSite('https://www.youtube.com/@TyroServ')">
            <i class="ri-youtube-fill icone-left"></i>
        </div>
        <div id="tiktok" class="btnleft" onclick="launchSite('https://www.tiktok.com/@tyroserv?')">
            <i class="ri-tiktok-fill icone-left"></i>
        </div>
        <div id="linkedin" class="btnleft" onclick="launchSite('https://www.linkedin.com/company/tyroserv')">
            <i class="ri-linkedin-box-fill icone-left"></i>
        </div>

        <img id="tyroliumsite" onclick="launchSite('https://tyrolium.fr')" src="asset/tyroliumwite.png">

    </section>

<!--  SELECT SERV  -->

    <section id="selectplay">

        <div id="barChoose"></div>

        <div id="backServAll"></div>

        <div id="serv-faction" onclick="switchLauncher('faction')"><img src="asset/logo3d.png"></div>
        <div id="serv-game" onclick="switchLauncher('minigame')"><img src="asset/logominigame.png"></div>
        <div id="serv-vanilla" onclick="switchLauncher('vanilla')"><img src="asset/minecraft.png"></div>

    </section>

<!-- DOWN PANEL -->
    <section id="down-panel">

        <div id="downbar">

            <h3 id="player" class="btn" onclick="launchSite('https://fr.namemc.com/server/mc.tyrolium.fr')">
                JOUEUR <div id="joueur"><p><span id="inPlayerInfo">0</span>/<span id="maxPlayerInfo">1000</span></p></div>
            </h3>
            <h3 id="minecraft" style="display: none" class="btn" onclick="launchSite('https://www.minecraft.net/')">
                MINECRAFT
            </h3>

            <h3 id="ping" class="btn" onclick="launchSite('https://stats.uptimerobot.com/7z9o3SEnWX')">
                STATUS <div id="cercle"></div>

                <div class="menu" id="menu">
                    <span id="pingValue">0</span> ms
                </div>
            </h3>

            <button id="toggleButton">
                <i id="arrow" class="ri-arrow-up-s-line"></i>
                <h1 id="play">
                    Jouer
                </h1>
            </button>

            <h3 id="mods" class="btn" onclick="launchOnglet('mods')">
                MODS
            </h3>

            <h3 id="shop" class="btn" onclick="launchSite('https://tyrolium.tebex.io')">
                BOUTIQUE
            </h3>

        </div>


        <div class="bar">
            <div id="progressBar"><!--<div id="slide"><p>0%</p></div>--></div>
        </div>

    </section>
</main>
<style>
    .bar {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0;
        transition: height 0.5s ease-in-out;
    }

    .show {
        height: 80px;
    }

</style>
<script>
    document.getElementById('toggleButton').addEventListener('click', function() {

        if (document.getElementById('play').innerText !== "SOON" && document.getElementById('play').innerText !== "EN COURS"){
            var bar = document.querySelector('.bar');
            bar.classList.toggle('show');
            var downpanel = document.getElementById('down-panel');
            downpanel.classList.toggle('up');
            var arrow = document.getElementById('arrow');
            arrow.classList.toggle('ri-arrow-up-s-line');
            arrow.classList.toggle('ri-arrow-down-s-line');
        }

    });

</script>


<!-- NAVBAR ET AUTH -->
<script src="module/navbar.js"></script>
<script src="authUseritium.js"></script>

<script>

    const { shell } = require('electron');
    const { ipcRenderer } = require('electron');
    const ipc = require("electron").ipcRenderer;

    let ErreurLaunchControl = 0;


    // Declancher le ping
    let ipServerFaction = "vps214.tyrolium.fr";

    document.getElementById('ping').addEventListener('mouseenter', function() {
        var pingValue;
        getInfoTechnicalServer(ipServerFaction)
            .then(function(infoTechnicalServer) {

                if (infoTechnicalServer.ping){
                    pingValue = infoTechnicalServer.ping
                } else {
                    pingValue = "3"
                }
                document.getElementById('pingValue').innerText = pingValue;

        }).catch(function(error) {
            console.log(error);
            pingValue = "none";
            document.getElementById('pingValue').innerText = pingValue;
        });
    });

    // Aficher le nombre de joueur sur le serveur
    getInfoTechnicalServer(ipServerFaction)
        .then(function(infoTechnicalServer) {
            console.log(infoTechnicalServer);
            document.getElementById('inPlayerInfo').innerText = infoTechnicalServer.players;
            document.getElementById('maxPlayerInfo').innerText = infoTechnicalServer.maxplayers;

        }).catch(function(error) {

            document.getElementById('inPlayerInfo').innerText = "??";
            document.getElementById('maxPlayerInfo').innerText = "??";
        });


    // RECUPERATION DE L'UTILISATEUR
    let userConnected = undefined;
    ipcRenderer.send('getUserConnected');

    // Recevoir les données utilisateur du processus principal
    ipcRenderer.on('userConnected', (event, data) => {

        console.log(data);
        userConnected = data;

        if (userConnected){

            var pseudo = document.getElementById("pseudo");
            var PP = document.getElementById("PP");
            var useritium_pseudo = document.getElementById("useritium-pseudo");
            var useritium_account = document.getElementById("useritium-account");

            pseudo.innerText = userConnected.pseudo;
            if (userConnected.useritium.pp){
                useritium_account.src = "https://useritium.fr/uploads/pp/" + userConnected.useritium.pp;
            } else {
                useritium_account.src = "https://tyrolium.fr/generate-pp/?l=" + userConnected.pseudo.charAt(0);
            }

            if (userConnected.useritium.displayname){
                useritium_pseudo.innerText = userConnected.useritium.displayname;
            } else {

                if (userConnected.useritium.username !== userConnected.pseudo){
                    useritium_pseudo.innerText = userConnected.useritium.username;
                } else {
                    useritium_pseudo.innerText = " ";
                }

            }

            if (userConnected.skin){
                PP.style.backgroundImage = "url('https://useritium.fr/uploads/skin/headView.php?scale=20&pictureName=" + userConnected.skin + "')";
            } else {
                PP.style.backgroundImage = "url('https://minotar.net/helm/" + userConnected.pseudo + "')";
            }

            getInfoServer(userConnected.pseudo)
                .then(function(infoServUser) {
                    // console.log(infoServUser);


                    var level_div = document.getElementById("level-user");
                    var level_text = document.getElementById("level-user-text");

                    // VERIFICATION DE L'EXISTANCE DE L'UTILISATEUR
                    if (infoServUser['result']['player'] !== "no player"){

                        // FACTION
                        if (infoServUser['result']['roles'] !== "no roles"){
                            var grade_div = document.getElementById("grade-user");
                            grade_div.classList.add("show-tag");

                            let allRoles = infoServUser['result']['roles'];
                            allRoles.forEach(oneRoles =>{

                                if (oneRoles['name'] !== "default"){
                                    var grade_text = document.getElementById("grade-user-text");
                                    grade_text.innerText +=  oneRoles['displayName'];
                                }

                            })

                        }

                        // FACTION
                        if (infoServUser['result']['faction']['id'] !== "0"){
                            var faction_div = document.getElementById("faction-user");
                            faction_div.classList.add("show-tag");
                            var faction_text = document.getElementById("faction-user-text");
                            faction_text.innerText = "Faction : " + infoServUser['result']['faction']['name'];
                        }

                        // MONEY
                        var money_div = document.getElementById("money-user");
                        money_div.classList.add("show-tag");
                        var money_text = document.getElementById("money-user-text");
                        money_text.innerText = infoServUser['result']['money']['wallet'] + " $";

                    } else {

                        level_div.classList.add("show-tag");
                        level_text.innerText = "Première connexion";


                    }

                })
                .catch(function(error) {
                    console.log(error);
                });
        }

    });

    // RECUPERATION INFO TECHNIQUE SERVEUR
    function getInfoTechnicalServer(ipServerFaction) {
        return new Promise((resolve, reject) => {
            fetch('https://mcapi.xdefcon.com/server/'+ipServerFaction+'/full/json')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    resolve(data);
                })
                .catch(function(error) {
                    reject(error);
                });
        });
    }

    // RECUPERATION DES INFOS DU SERVEUR
    function getInfoServer(pseudo) {
        return new Promise((resolve, reject) => {
            fetch('http://vps214.tyrolium.fr/api-tyroserv/?pseudo=' + pseudo)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    resolve(data);
                })
                .catch(function(error) {
                    reject(error);
                });
        });
    }

    // BTN DE LANCEMENT DU JEUX
    var playbtn = document.getElementById("play");

    playbtn.addEventListener("click", e => {

        if (playbtn.innerText === "JOUER"){

            startMinecraft(userConnected, hereServer);

            playbtn.innerText = "LANCEMENT";
            ErreurLaunchControl = 0;
        }


    });

    // BAR DE CHARGEMENT
    ipcRenderer.on('progression', (event, data) => {

        const progressBar = document.getElementById('progressBar');

        let pourcentage = (data.task / data.total) * 100;
        let pourcentageAffiche = Math.floor((data.task / data.total) * 100);
        let affichage = convertPercentageToCustomScale(pourcentageAffiche);
        console.log("affichage", affichage)
        // progressBar.innerHTML = "<p> Type : " + data.type  + " | Task : " + data.task + " | total : " + data.total + "</p>"
        progressBar.innerHTML = '<div id="slide" style="width:' + affichage + '%!important;"><p>' + pourcentageAffiche + '%</p></div>'

    });

    // BAR D'INSTALLATION
    ipcRenderer.on('progressionDownload', (event, data) => {

        const progressBar = document.getElementById('progressBar');

        let pourcentage = (data.current / data.total) * 100;
        let pourcentageAffiche = Math.floor((data.current / data.total) * 100);
        let affichage = convertPercentageToCustomScale(pourcentageAffiche);
        // console.log("affichage", affichage)
        // progressBar.innerHTML = "<p> Type : " + data.type  + " | Task : " + data.task + " | total : " + data.total + "</p>"
        progressBar.innerHTML = '<div id="slide" style="width:' + affichage + '%!important;"><p>' + pourcentageAffiche + '%</p></div>'

    });

    function convertPercentageToCustomScale(percentage) {
        // Assurez-vous que le pourcentage est compris entre 0 et 100
        percentage = Math.max(0, Math.min(100, percentage));

        // Convertir le pourcentage en échelle personnalisée
        const customScale = (percentage * (92.5 - 1) / 100) + 1;

        return customScale;
    }

    // BAR AU LANCEMENT
    ipcRenderer.on('lancement', (event, data) => {

        if (data === "[MCLC]: Set launch options"){

            var btnPlay = document.getElementById("play");

            btnPlay.innerText = "EN COURS";

            const progressBar = document.getElementById('progressBar');
            progressBar.innerHTML = null;

            var bar = document.querySelector('.bar');
            bar.classList.remove('show');
            var downpanel = document.getElementById('down-panel');
            downpanel.classList.remove('up');
            var arrow = document.getElementById('arrow');
            arrow.classList.add('ri-arrow-up-s-line');
            arrow.classList.remove('ri-arrow-down-s-line');

        }

        if (data === "[MCLC]: Failed to start due to Error: Invalid or unsupported zip format. No END header found, closing..." && ErreurLaunchControl === 0) {

            const progressBar = document.getElementById('progressBar');
            progressBar.innerHTML = "<p> </p>"

            playbtn.innerText = "JOUER";

            var bar = document.querySelector('.bar');
            bar.classList.remove('show');
            var downpanel = document.getElementById('down-panel');
            downpanel.classList.remove('up');
            var arrow = document.getElementById('arrow');
            arrow.classList.add('ri-arrow-up-s-line');
            arrow.classList.remove('ri-arrow-down-s-line');


            notif("err", "Votre jeu n'a pas réussi à se lancer. Veuillez recommencer.");

            ErreurLaunchControl += 1;


        }

    });


    // ARRET DU JEUX (RETOUR A LA NORMAL)
    ipcRenderer.on('stopping', (event, data) => {
        // console.log("Data : ", data)
        const progressBar = document.getElementById('progressBar');
        progressBar.innerHTML = "<p> </p>"

        playbtn.innerText = "JOUER";

        var bar = document.querySelector('.bar');
        bar.classList.remove('show');
        var downpanel = document.getElementById('down-panel');
        downpanel.classList.remove('up');
        var arrow = document.getElementById('arrow');
        arrow.classList.add('ri-arrow-up-s-line');
        arrow.classList.remove('ri-arrow-down-s-line');

        getInfoServer(userConnected.pseudo)
            .then(function(infoServUser) {
                console.log(infoServUser);


                var level_div = document.getElementById("level-user");
                var level_text = document.getElementById("level-user-text");

                // VERIFICATION DE L'EXISTANCE DE L'UTILISATEUR
                if (infoServUser['result']['player'] !== "no player"){

                    // FACTION
                    if (infoServUser['result']['roles'] !== "no roles"){
                        var grade_div = document.getElementById("grade-user");
                        grade_div.classList.add("show-tag");

                        var grade_text = document.getElementById("grade-user-text");
                        grade_text.innerText = null

                        let allRoles = infoServUser['result']['roles'];
                        allRoles.forEach(oneRoles =>{

                            if (oneRoles['name'] !== "default"){
                                grade_text.innerText +=  oneRoles['displayName'];
                            }

                        })

                    }

                    // FACTION
                    if (infoServUser['result']['faction']['id'] !== "0"){
                        var faction_div = document.getElementById("faction-user");
                        faction_div.classList.add("show-tag");
                        var faction_text = document.getElementById("faction-user-text");
                        faction_text.innerText = "Faction : " + infoServUser['result']['faction']['name'];
                    }

                    // MONEY
                    var money_div = document.getElementById("money-user");
                    money_div.classList.add("show-tag");
                    var money_text = document.getElementById("money-user-text");
                    money_text.innerText = infoServUser['result']['money']['wallet'] + " $";

                } else {

                    level_div.classList.add("show-tag");
                    level_text.innerText = "Première connexion";


                }

            })
            .catch(function(error) {
                console.log(error);
            });

    });

    // LANCEMENT DE SITE
    function launchSite(url){
        if (url === "https://tyroserv.fr/player/"){
            // userConnected.pseudo
            shell.openExternal(url + userConnected.pseudo);
        } else {
            shell.openExternal(url);
        }
    }

    // LANCEMENT D'ONGLET
    function launchOnglet(onglet) {

        if (onglet === 'mods' && hereServer === "faction"){
            ipc.send("launchMods");
        }

        if (onglet === 'settings'){
            ipc.send("launchSettings");
        }

        if (onglet === 'version' && hereServer === "faction"){
            ipc.send("launchVersion");
        }

    }


    // CHANGESERV
    let hereServer = "faction"
    function switchLauncher(futur){

        var playBtn = document.getElementById("play");

        if (futur !== hereServer && playBtn.innerText !== "LANCEMENT" && playBtn.innerText !== "EN COURS"){

            var bodyPanel = document.getElementById("panel");
            var nameServer = document.getElementById("name-serv");
            var typeServer = document.getElementById("type-serv");
            var imgServer = document.getElementById("img-serv");
            var barChoose = document.getElementById("barChoose");
            var statsPerso = document.getElementById("stats-perso");
            var btnMods = document.getElementById("mods");
            var btnJoueur = document.getElementById("player");
            var btnMinecraft = document.getElementById("minecraft");
            var backNbJoueur = document.getElementById("joueur");


            if (futur === "faction"){

                bodyPanel.style.backgroundImage = "url('asset/back/Launcher.png')";
                nameServer.style.color = "#1400FF";
                nameServer.style.left = "937px";
                nameServer.innerText = "TYROSERV";
                typeServer.innerText = "PVP/FACTION";
                typeServer.style.left = "839px";
                imgServer.src = "asset/logo3d.png";

                barChoose.style.top = "280px";
                barChoose.style.background = "#1400FF";
                statsPerso.style.display = "flex";
                backNbJoueur.style.backgroundColor = "#002D85"

                playBtn.innerText = "JOUER";
                btnMods.innerText = "MODS";
                btnJoueur.style.display = "flex";
                btnMinecraft.style.display = "none";

                hereServer = futur;

            }
            if (futur === "minigame"){

                bodyPanel.style.backgroundImage = "url('asset/back/sky.png')";
                nameServer.style.color = "#FF0000";
                nameServer.style.left = "937px";
                nameServer.innerText = "TYROSERV";
                typeServer.innerText = "MINI-JEUX";
                typeServer.style.left = "897px"
                imgServer.src = "asset/logominigame.png";

                barChoose.style.top = "363px";
                barChoose.style.background = "#FF0000";
                statsPerso.style.display = "none";
                backNbJoueur.style.backgroundColor = "#FF0000"

                playBtn.innerText = "SOON";
                btnMods.innerText = "MODS";
                btnJoueur.style.display = "flex";
                btnMinecraft.style.display = "none";

                hereServer = futur;

            }
            if (futur === "vanilla"){

                bodyPanel.style.backgroundImage = "url('asset/back/vanilla.jpeg')";
                nameServer.style.color = "#0ABE06";
                nameServer.style.left = "915px";
                nameServer.innerText = "MINECRAFT";
                typeServer.innerText = "VANILLA";
                typeServer.style.left = "932px";
                imgServer.src = "asset/minecraft.png";

                barChoose.style.top = "446px";
                barChoose.style.background = "#0ABE06";
                statsPerso.style.display = "none";

                playBtn.innerText = "SOON";
                btnMods.innerText = "VERSION";
                btnJoueur.style.display = "none";
                btnMinecraft.style.display = "block";

                hereServer = futur;
            }

        }

    }


    // NOTIFICATION
    function notif(status, why){
        if(status == "true"){

            iziToast.success({
                title: 'OK',
                message: why,
                position: "topCenter",
            });

            playbtn.disabled = true;

        }
        if(status == "err"){

            iziToast.error({
                title: 'Erreur',
                message: why,
                position: "topCenter",
            })

        }
        if(status == "info"){

            iziToast.info({
                title: 'Info',
                message: why,
                position: "topCenter",
            })

        }
    }
</script>


</body>

</html>
